---
title: "Conditional Formatting"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Conditional Formatting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
set.seed(123)
```

```{r setup}
library(openxlsx2)
```

```{r}
wb <- wb_workbook()
wb$add_worksheet("cellIs")
negStyle <- create_dxfs_style(font_color = c(rgb = "FF9C0006"), bgFill = c(rgb = "FFFFC7CE"))
posStyle <- create_dxfs_style(font_color = c(rgb = "FF006100"), bgFill = c(rgb = "FFC6EFCE"))
wb$styles_mgr$styles$dxfs <- c(wb$styles_mgr$styles$dxfs, c(negStyle, posStyle))
```

## Rule applies to all each cell in range

```{r}
wb$add_data("cellIs", -5:5)
wb$add_data("cellIs", LETTERS[1:11], startCol = 2)
wb$add_conditional_formatting("cellIs",
                     cols = 1,
                     rows = 1:11, rule = "!=0", style = negStyle
)
wb$add_conditional_formatting("cellIs",
                     cols = 1,
                     rows = 1:11, rule = "==0", style = posStyle
)
wb$add_worksheet("Moving Row")
```

## Highlight row dependent on first cell in row

```{r}
wb$add_data("Moving Row", -5:5)
wb$add_data("Moving Row", LETTERS[1:11], startCol = 2)
wb$add_conditional_formatting("Moving Row",
                     cols = 1:2,
                     rows = 1:11, rule = "$A1<0", style = negStyle
)
wb$add_conditional_formatting("Moving Row",
                     cols = 1:2,
                     rows = 1:11, rule = "$A1>0", style = posStyle
)
wb$add_worksheet("Moving Col")
```

## Highlight column dependent on first cell in column

```{r}
wb$add_data("Moving Col", -5:5)
wb$add_data("Moving Col", LETTERS[1:11], startCol = 2)
wb$add_conditional_formatting("Moving Col",
                     cols = 1:2,
                     rows = 1:11, rule = "A$1<0", style = negStyle
)
wb$add_conditional_formatting("Moving Col",
                     cols = 1:2,
                     rows = 1:11, rule = "A$1>0", style = posStyle
)
wb$add_worksheet("Dependent on")
```

## Highlight entire range cols X rows dependent only on cell A1

```{r}
wb$add_data("Dependent on", -5:5)
wb$add_data("Dependent on", LETTERS[1:11], startCol = 2)
wb$add_conditional_formatting("Dependent on",
                     cols = 1:2,
                     rows = 1:11, rule = "$A$1<0", style = negStyle
)
wb$add_conditional_formatting("Dependent on",
                     cols = 1:2,
                     rows = 1:11, rule = "$A$1>0", style = posStyle
)
```

## Highlight cells in column 1 based on value in column 2

```{r}
wb$add_data("Dependent on", data.frame(x = 1:10, y = runif(10)), startRow = 15)
wb$add_conditional_formatting("Dependent on",
                     cols = 1,
                     rows = 16:25, rule = "B16<0.5", style = negStyle
)
wb$add_conditional_formatting("Dependent on",
                     cols = 1,
                     rows = 16:25, rule = "B16>=0.5", style = posStyle
)
wb$add_worksheet("Duplicates")
```

## Highlight duplicates using default style

```{r}
wb$add_data("Duplicates", sample(LETTERS[1:15], size = 10, replace = TRUE))
wb$add_conditional_formatting("Duplicates", cols = 1, rows = 1:10, type = "duplicates")
wb$add_worksheet("containsText")
```

## Cells containing text

```{r}
fn <- function(x) paste(sample(LETTERS, 10), collapse = "-")
wb$add_data("containsText", sapply(1:10, fn))
wb$add_conditional_formatting("containsText", cols = 1, rows = 1:10, type = "contains", rule = "A")
wb$add_worksheet("notcontainsText")
```

## Cells not containing text

```{r}
fn <- function(x) paste(sample(LETTERS, 10), collapse = "-")
wb$add_data("containsText", sapply(1:10, fn))
wb$add_conditional_formatting("notcontainsText", cols = 1,
                     rows = 1:10, type = "notcontains", rule = "A")
wb$add_worksheet("beginsWith")
```

## Cells begins with text

```{r}
fn <- function(x) paste(sample(LETTERS, 10), collapse = "-")
wb$add_data("beginsWith", sapply(1:100, fn))
wb$add_conditional_formatting("beginsWith", cols = 1, rows = 1:100, type = "beginsWith", rule = "A")
wb$add_worksheet("endsWith")
```

## Cells ends with text

```{r}
fn <- function(x) paste(sample(LETTERS, 10), collapse = "-")
wb$add_data("endsWith", sapply(1:100, fn))
wb$add_conditional_formatting("endsWith", cols = 1, rows = 1:100, type = "endsWith", rule = "A")
wb$add_worksheet("colourScale", zoom = 30)
```

## Colourscale colours cells based on cell value

```{r}
df <- read_xlsx(system.file("extdata", "readTest.xlsx", package = "openxlsx2"), sheet = 4)
wb$add_data("colourScale", df, colNames = FALSE) ## write data.frame
```

Rule is a vector or colours of length 2 or 3 (any hex colour or any of `colours()`).
If rule is `NULL`, min and max of cells is used. Rule must be the same length as style or L.

```{r}
wb$add_conditional_formatting("colourScale",
                     cols = seq_along(df), rows = 1:nrow(df),
                     style = c("black", "white"),
                     rule = c(0, 255),
                     type = "colourScale"
)
wb_set_col_widths(wb, "colourScale", cols = seq_along(df), widths = 1.07)
wb <- wb_set_row_heights(wb, "colourScale", rows = seq_len(nrow(df)), heights = 7.5)
wb$add_worksheet("databar")
```

## Databars

```{r}
wb$add_data("databar", -5:5)
wb$add_conditional_formatting("databar", cols = 1, rows = 1:11, type = "databar") ## Default ours
wb$add_worksheet("between")
```

## Between

Highlight cells in interval [-2, 2]

```{r}
wb$add_data("between", -5:5)
wb$add_conditional_formatting("between", cols = 1, rows = 1:11, type = "between", rule = 2, 2)
wb$add_worksheet("topN")
```

## Top N

```{r}
wb$add_data("topN", data.frame(x = 1:10, y = rnorm(10)))
```

Highlight top 5 values in column x

```{r}
wb$add_conditional_formatting(
  "topN", 
  cols = 1,
  rows = 2:11,
  style = posStyle,
  type = "topN",
  rank = 5
)
```

Highlight top 20 percentage in column y

```{r}
wb$add_conditional_formatting("topN", cols = 2, rows = 2:11,
                     style = posStyle, type = "topN", rank = 20, percent = TRUE)
wb$add_worksheet("bottomN")
```

Bottom N

```{r}
wb$add_data("bottomN", data.frame(x = 1:10, y = rnorm(10)))
```

Highlight bottom 5 values in column x

```{r}
wb$add_conditional_formatting(
  "bottomN",
  cols = 1,
  rows = 2:11,
  style = negStyle, 
  type = "topN",
  rank = 5
)
```

Highlight bottom 20 percentage in column y

```{r}
wb$add_conditional_formatting("bottomN", cols = 2, rows = 2:11,
                     style = negStyle, type = "topN", rank = 20, percent = TRUE)
wb$add_worksheet("logical operators")
```

## Logical Operators

You can use Excels logical Operators

```{r}
wb$add_data("logical operators", 1:10)
wb$add_conditional_formatting("logical operators",
                     cols = 1, rows = 1:10,
                     rule = "OR($A1=1,$A1=3,$A1=5,$A1=7)"
)
```
